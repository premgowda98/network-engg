# HTTPS MITM Proxy Certificate Analysis

## MITM Proxy Certificate Files

```bash
docker exec -it ba07e063658b /bin/bash
root@premgowda-Latitude-7490:/# ls
bin  boot  dev	etc  home  lib	lib64  media  mnt  opt	proc  root  run  sbin  srv  sys  tmp  usr  var
root@premgowda-Latitude-7490:/# cd home/mitmproxy/
root@premgowda-Latitude-7490:/home/mitmproxy# cd .mitmproxy/
root@premgowda-Latitude-7490:/home/mitmproxy/.mitmproxy# ls
mitmproxy-ca-cert.cer  mitmproxy-ca-cert.p12  mitmproxy-ca-cert.pem  mitmproxy-ca.p12  mitmproxy-ca.pem  mitmproxy-dhparam.pem
root@premgowda-Latitude-7490:/home/mitmproxy/.mitmproxy# 
```

### Certificate Files Explanation

1. **`mitmproxy-ca-cert.pem`** - CA Certificate (Public Key Only)
   - Contains the Certificate Authority certificate in PEM format
   - Used by clients to verify certificates generated by mitmproxy
   - This is what you install in `/usr/local/share/ca-certificates/`

2. **`mitmproxy-ca-cert.cer`** - CA Certificate (DER format)
   - Same as .pem but in binary DER format
   - Used for Windows/browsers that prefer .cer format

3. **`mitmproxy-ca-cert.p12`** - CA Certificate + Private Key (PKCS#12)
   - Contains both certificate and private key in password-protected format
   - Used for importing into browsers/applications that need both

4. **`mitmproxy-ca.pem`** - CA Private Key
   - Contains the private key used to sign certificates
   - Used by mitmproxy to generate fake certificates on-the-fly

5. **`mitmproxy-ca.p12`** - CA Bundle (PKCS#12)
   - Alternative format containing certificate and private key

6. **`mitmproxy-dhparam.pem`** - Diffie-Hellman Parameters
   - Used for perfect forward secrecy in TLS connections

## HTTPS Interception Process

### Normal HTTPS Connection (Without Proxy)
```
Client (curl) ←→ HTTPS ←→ Server (example.com)
     |                         |
     └── Direct encrypted communication
```

### HTTPS Connection Through MITM Proxy

#### Phase 1: Client to MITM Proxy
```
Client (curl) ←→ HTTPS ←→ MITM Proxy
     |                      |
     |                      └── Uses mitmproxy-generated certificate
     |                          (signed by mitmproxy CA)
     |
     └── Verifies certificate against installed mitmproxy CA
```

#### Phase 2: MITM Proxy to Server
```
MITM Proxy ←→ HTTPS ←→ Server (example.com)
     |                    |
     └── Separate encrypted connection
         (proxy acts as normal client)
```

### Complete Flow Diagram

```
┌─────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Client    │    │   MITM Proxy    │    │ Server          │
│   (curl)    │    │  (mitmproxy)    │    │ (example.com)   │
└─────────────┘    └─────────────────┘    └─────────────────┘
       │                     │                      │
       │ 1. CONNECT request  │                      │
       │────────────────────►│                      │
       │                     │                      │
       │ 2. 200 Connection   │                      │
       │    Established      │                      │
       │◄────────────────────│                      │
       │                     │                      │
       │ 3. TLS ClientHello  │                      │
       │────────────────────►│                      │
       │                     │ 4. Generate fake     │
       │                     │    cert for          │
       │                     │    example.com       │
       │                     │    (signed by CA)    │
       │                     │                      │
       │ 5. TLS ServerHello  │                      │
       │    + Fake Cert      │                      │
       │◄────────────────────│                      │
       │                     │                      │
       │ 6. Verify cert      │                      │
       │    against CA       │                      │
       │                     │                      │
       │ 7. Encrypted data   │                      │
       │────────────────────►│                      │
       │                     │ 8. Decrypt & Log    │
       │                     │                      │
       │                     │ 9. New TLS to server │
       │                     │─────────────────────►│
       │                     │                      │
       │                     │10. Real cert from    │
       │                     │    example.com       │
       │                     │◄─────────────────────│
       │                     │                      │
       │                     │11. Forward request   │
       │                     │─────────────────────►│
       │                     │                      │
       │                     │12. Response          │
       │                     │◄─────────────────────│
       │                     │                      │
       │13. Encrypted resp   │                      │
       │◄────────────────────│                      │
```

## Certificate Usage in Each Phase

### Phase 1: Client → MITM Proxy
- **Certificate Used**: Fake certificate for `example.com` generated by mitmproxy
- **Signed By**: mitmproxy CA (using `mitmproxy-ca.pem` private key)
- **Verification**: Client verifies against installed `mitmproxy-ca-cert.pem`

### Phase 2: MITM Proxy → Server
- **Certificate Used**: Real certificate from `example.com`
- **Signed By**: Real CA (e.g., Let's Encrypt, DigiCert)
- **Verification**: Proxy verifies against system CA store

## What Happens Without Installing MITM Certificate

### Scenario: MITM Certificate NOT Installed

```bash
# This will fail with certificate verification error
curl -x http://mitmproxy:8080 https://example.com
```

**Error Flow:**
```
┌─────────────┐    ┌─────────────────┐
│   Client    │    │   MITM Proxy    │
│   (curl)    │    │  (mitmproxy)    │
└─────────────┘    └─────────────────┘
       │                     │
       │ 1. TLS Handshake    │
       │────────────────────►│
       │                     │
       │ 2. Fake Certificate │
       │◄────────────────────│
       │                     │
       │ 3. Certificate      │
       │    Verification     │
       │    FAILS!           │
       │                     │
       │ 4. SSL Error        │
       │    Connection       │
       │    Terminated       │
```

**Error Messages:**
- `SSL certificate problem: unable to get local issuer certificate`
- `certificate verify failed: unable to get local issuer certificate`

### Workarounds (Not Recommended for Production)
```bash
# Skip certificate verification (INSECURE)
curl -k -x http://mitmproxy:8080 https://example.com

# Specify custom CA bundle
curl --cacert /path/to/mitmproxy-ca-cert.pem -x http://mitmproxy:8080 https://example.com
```

## Proper Certificate Installation

### Install MITM CA Certificate
```bash
# Copy certificate to system CA directory
sudo cp mitmproxy-ca-cert.pem /usr/local/share/ca-certificates/mitmproxy-ca.crt

# Update system CA store
sudo update-ca-certificates

# Verify installation
curl -x http://mitmproxy:8080 https://example.com
```

### Verification Commands
```bash
# Check if certificate is in system store
grep -r "mitmproxy" /etc/ssl/certs/ca-certificates.crt

# Test with curl
curl -v -x http://mitmproxy:8080 https://example.com 2>&1 | grep -i certificate
```

## Security Implications

### Why MITM Works
1. **Trust Chain**: Client trusts mitmproxy CA → mitmproxy CA signs fake certificates → Client accepts fake certificates
2. **Decryption**: Proxy can decrypt all traffic because it has the private keys for the fake certificates
3. **Re-encryption**: Proxy establishes separate encrypted connection to real server

### Detection Methods
- Certificate pinning
- Certificate transparency logs
- Comparing certificate fingerprints
- Monitoring for certificate changes

### Legitimate Use Cases
- Corporate network monitoring
- Security testing and penetration testing
- Development and debugging
- Malware analysis